!function(){for(var t,e=function(){},n=["assert","clear","count","debug","dir","dirxml","error","exception","group","groupCollapsed","groupEnd","info","log","markTimeline","profile","profileEnd","table","time","timeEnd","timeStamp","trace","warn"],o=n.length,i=window.console=window.console||{};o--;)t=n[o],i[t]||(i[t]=e)}();var Testrails=new Backbone.Marionette.Application;Testrails.addRegions({sidebar:".trs-base-sidebar",diagram:".trs-base-diagram"}),Testrails.on("initialize:after",function(){Backbone.history.start()}),Testrails.module("Model.Definition",function(t,e,n,o,i){t.Array=n.Collection.extend({add:function(t,e){return this.addAtIndex(this.length,t,e)},addAtIndex:function(t,e){0>t&&(t=0);for(var n=this.length;n>t;n--)this.models[n]=this.models[n-1];return this.models[t]=e,this.length++,e},removeIndex:function(t){for(var e=this.models[n],n=t;n<this.length-1;n++)this.models[n]=this.models[n+1];return this.pop(),e},replaceIndex:function(t,e){var n=this.models[t];return this.models[t]=e,n}}),t.SensorReading=n.Model.extend({defaults:{timestamp:null,data:null,forSystemActivity:null,forSensorReadingSequence:null},initialize:function(){this.set("data",{})}}),t.SensorReadingList=n.Collection.extend({model:t.SensorReading}),t.SensorReadingSequence=n.Model.extend({defaults:{outline:null,sensorReadings:null,inProgress:!0,characteristics:null},initialize:function(){var e=new t.SensorReadingList;this.set("sensorReadings",e);var n=this;e.on("all",function(){n.trigger("change",this,{})}),this.set("characteristics",{})},getLabel:function(){var t=String();return i.each(this.get("characteristics"),function(e,n){t+=e+": "+n+"; "}),t.length>=2?t.substring(0,t.length-2):t}}),t.SensorReadingSequenceList=n.Collection.extend({model:t.SensorReadingSequence}),t.SensorReadingSequenceOutline=n.Model.extend({defaults:{startActivities:null,endActivities:null}}),t.SensorReadingSequenceOutlineList=n.Collection.extend({model:t.SensorReadingSequenceOutline}),t.SystemActivity=n.Model.extend({defaults:{name:"",identificationRule:null}}),t.SystemActivityList=n.Collection.extend({model:t.SystemActivity}),t.SystemActivityIdentificationRule=n.Model.extend({defaults:{version:1}}),t.UsageScenarioIdentificationRule=n.Model.extend({defaults:{name:"",startActivities:null,endActivities:null,identificationRule:null}})}),Testrails.module("Model",function(t){t.addInitializer(function(){t.systemActivities=new t.Definition.SystemActivityList,t.sensorReadingSequences=new t.Definition.SensorReadingSequenceList})}),Testrails.module("Simulator.View",function(t,e,n,o,i,s){t.MainView=o.ItemView.extend({template:"#trs-sim-tmpl-mainview",tagName:"div",className:"trs-base-sidebar-container",ui:{inputSrsCKey:"#trs-eventsim-srs-ckey",inputSrsCVal:"#trs-eventsim-srs-cval",containerSrsList:"#trs-eventsim-srs-list",containerSrsSelect:"#trs-sim-srs-select",inputSaName:"#trs-sim-sa-name",containerSaList:"#trs-eventsim-sa-list",containerSaSelect:"#trs-sim-sa-select"},events:{"keypress #trs-eventsim-srs-ckey":"onStartSensorReadingSequenceKeypress","keypress #trs-eventsim-srs-cval":"onStartSensorReadingSequenceKeypress","click .trs-eventsim-srs-start":"onStartSensorReadingSequence","keypress #trs-sim-sa-name":"onAddSystemActivityKeypress","click .trs-sim-sa-add":"onAddSystemActivity","click .trs-sim-sr-add":"onAddSensorReading"},onStartSensorReadingSequenceKeypress:function(t){13===t.which&&this.onStartSensorReadingSequence()},onStartSensorReadingSequence:function(){var t=this.ui.inputSrsCKey.val().trim(),n=this.ui.inputSrsCVal.val().trim();if(""!=t&&""!=n){var o=new e.Model.Definition.SensorReadingSequence,i={};i[t]=n,o.set("characteristics",i),e.Model.sensorReadingSequences.add(o),this.ui.inputSrsCKey.val(""),this.ui.inputSrsCVal.val(""),this.ui.inputSrsCKey.focus()}},onAddSystemActivityKeypress:function(t){13===t.which&&this.onAddSystemActivity()},onAddSystemActivity:function(){var t=this.ui.inputSaName.val().trim();if(""!=t){var n=new e.Model.Definition.SystemActivity;n.set("name",t),e.Model.systemActivities.add(n),this.ui.inputSaName.val(""),this.ui.inputSaName.focus()}},onAddSensorReading:function(){var t=this.ui.containerSrsSelect.val(),n=this.ui.containerSaSelect.val();if(null!=t&&null!=n){var o=e.Model.sensorReadingSequences.get(t),i=e.Model.systemActivities.get(n),s=new e.Model.Definition.SensorReading;s.set("timestamp",Date.now()),s.set("forSystemActivity",i),s.set("forSensorReadingSequence",o),o.get("sensorReadings").add(s)}},updateSensorReadingSequenceTable:function(){this.ui.containerSrsList.html(s.template(i("#trs-sim-tmpl-srslist").html(),{sensorReadingSequences:e.Model.sensorReadingSequences}))},updateSensorReadingSequenceSelect:function(){this.ui.containerSrsSelect.html(s.template(i("#trs-sim-tmpl-srssel").html(),{sensorReadingSequences:e.Model.sensorReadingSequences}))},updateSystemActivityTable:function(){this.ui.containerSaList.html(s.template(i("#trs-sim-tmpl-salist").html(),{systemActivities:e.Model.systemActivities}))},updateSystemActivitySelect:function(){this.ui.containerSaSelect.html(s.template(i("#trs-sim-tmpl-sasel").html(),{systemActivities:e.Model.systemActivities}))}}),t.addInitializer(function(){var n=new t.MainView({templateHelpers:{label:"Event:"}});e.sidebar.show(n),this.listenTo(e.Model.sensorReadingSequences,"all",function(){n.updateSensorReadingSequenceTable(),n.updateSensorReadingSequenceSelect()}),this.listenTo(e.Model.systemActivities,"all",function(){n.updateSystemActivityTable(),n.updateSystemActivitySelect()})})}),Testrails.module("Diagram.Model.Definition",function(t,e,n){t.SystemActivityNode=n.Model.extend({defaults:{position:{left:-1,top:-1},$el:null,gridPosition:{column:-1,row:-1},incomingConnections:null,outgoingConnections:null,sensorReadings:null,systemActivity:null},initialize:function(){this.set("incomingConnections",new t.ConnectionList),this.set("outgoingConnections",new t.ConnectionList),this.set("sensorReadings",new e.Model.Definition.SensorReadingList)},getIncomingConnectionFrom:function(t){return this.get("incomingConnections").find(function(e){return e.get("sourceNode")===t})},hasIncomingConnectionFrom:function(t){return void 0!==this.getIncomingConnectionFrom(t)},getOutgoingConnectionTo:function(t){return this.get("outgoingConnections").find(function(e){return e.get("targetNode")===t})},hasOutgoingConnectionTo:function(t){return void 0!==this.getOutgoingConnectionTo(t)}}),t.SystemActivityNodeList=n.Collection.extend({model:t.SystemActivityNode}),t.Connection=n.Model.extend({defaults:{$el:null,paper:null,sourceNode:null,targetNode:null},initialize:function(){null!=this.get("sourceNode")&&0!=this.get("targetNode")&&(0==this.get("sourceNode").hasOutgoingConnectionTo(this.get("targetNode"))&&this.get("sourceNode").get("outgoingConnections").add(this),0==this.get("targetNode").hasIncomingConnectionFrom(this.get("sourceNode"))&&this.get("targetNode").get("incomingConnections").add(this))},getFirstHorizonalLaneRow:function(){if(!this.get("sourceNode"))return-1;var t=this.get("sourceNode").get("gridPosition").row;return-1==t?-1:t+1},getFirstHorizonalLaneOffset:function(){if(!this.get("sourceNode"))return-1;var t=this.get("sourceNode").get("gridPosition").column,n=this.getFirstHorizonalLaneRow();if(-1==t||-1==n)return-1;var o=e.Diagram.Model.nodeCellGrid.at(t).at(n),i=o.getHorizontalLaneOffset(this),s=o.getHorizontalLaneCount();return{fromTop:i,fromBottom:s-i-1}},getFirstHorizontalLineLength:function(){if(!this.get("sourceNode")||!this.get("targetNode"))return 0;var t=this.get("sourceNode").get("gridPosition").column,e=this.get("targetNode").get("gridPosition").column,n=this.get("sourceNode").get("gridPosition").row,o=this.get("targetNode").get("gridPosition").row;return 0==e-t&&1==o-n?0:0==e-t&&1!=o-n?1:e-t>0?e-t:0>e-t?e-t:void 0},getVerticalLaneColumn:function(){if(!this.get("sourceNode")||!this.get("targetNode"))return 0;var t=this.get("sourceNode").get("gridPosition").column,e=this.get("targetNode").get("gridPosition").column;return-1==t||-1==e?-1:0>=e-t?e:e-t>0?e-1:void 0},getVerticalLaneOffset:function(){if(!this.get("sourceNode")||!this.get("targetNode"))return 0;var t=this.get("sourceNode").get("gridPosition").column,n=this.get("targetNode").get("gridPosition").column,o=this.get("sourceNode").get("gridPosition").row,i=this.get("targetNode").get("gridPosition").row;if(0==n-t&&1==i-o)return{fromLeft:0,fromRight:0};if(0!=n-t&&1==i-o)return{fromLeft:0,fromRight:0};if(i-o>1){var s=e.Diagram.Model.nodeCellGrid.at(this.getVerticalLaneColumn()).at(i-1),a=s.getVerticalLaneOffset(this),r=s.getVerticalLaneCount();return{fromLeft:a,fromRight:r-a-1}}if(1>i-o){var s=e.Diagram.Model.nodeCellGrid.at(this.getVerticalLaneColumn()).at(i),a=s.getVerticalLaneOffset(this),r=s.getVerticalLaneCount();return{fromLeft:a,fromRight:r-a-1}}},getVerticalLineLength:function(){if(!this.get("sourceNode")||!this.get("targetNode"))return 0;var t=this.get("sourceNode").get("gridPosition").column,e=this.get("targetNode").get("gridPosition").column,n=this.get("sourceNode").get("gridPosition").row,o=this.get("targetNode").get("gridPosition").row;return 0==e-t&&1==o-n?0:0!=e-t&&1==o-n?0:1>o-n?o-n-1:o-n>1?o-n-1:void 0},getSecondHorizontalLaneRow:function(){if(!this.get("targetNode"))return-1;var t=this.get("targetNode").get("gridPosition").row;return-1==t?-1:t},getSecondHorizontalLaneOffset:function(){if(!this.get("targetNode"))return-1;var t=this.get("targetNode").get("gridPosition").column,n=this.getSecondHorizontalLaneRow();if(-1==t||-1==n)return-1;var o=e.Diagram.Model.nodeCellGrid.at(t).at(n),i=o.getHorizontalLaneOffset(this),s=o.getHorizontalLaneCount();return{fromTop:i,fromBottom:s-i-1}},getSecondHorizontalLineLength:function(){if(!this.get("sourceNode")||!this.get("targetNode"))return 0;var t=this.get("sourceNode").get("gridPosition").column,e=this.get("targetNode").get("gridPosition").column,n=this.get("sourceNode").get("gridPosition").row,o=this.get("targetNode").get("gridPosition").row;if(0==e-t&&1==o-n)return 0;var i=this.getVerticalLaneColumn();return 0==i-e?-1:-1==i-e?1:void 0}}),t.ConnectionList=n.Collection.extend({model:t.Connection}),t.NodeCell=n.Model.extend({defaults:{systemActivityNode:null,connectionsTopToRight:null,connectionsTopToLeft:null,connectionsRightToTop:null,connectionsRightToBottom:null},initialize:function(){this.set("connectionsTopToRight",new e.Model.Definition.Array),this.set("connectionsTopToLeft",new e.Model.Definition.Array),this.set("connectionsRightToTop",new e.Model.Definition.Array),this.set("connectionsRightToBottom",new e.Model.Definition.Array)},isOccupied:function(){return null!=this.get("systemActivityNode")},getHorizontalLaneOffset:function(t){var e=this.get("connectionsTopToRight").indexOf(t);return-1!=e?e:(e=this.get("connectionsTopToLeft").indexOf(t),-1==e?-1:e+this.get("connectionsTopToRight").length)},getHorizontalLaneCount:function(){return this.get("connectionsTopToRight").length+this.get("connectionsTopToLeft").length},getVerticalLaneOffset:function(t){var e=this.get("connectionsRightToTop").indexOf(t);return-1!=e?e:(e=this.get("connectionsRightToBottom").indexOf(t),-1==e?-1:e+this.get("connectionsRightToTop").length)},getVerticalLaneCount:function(){return this.get("connectionsRightToTop").length+this.get("connectionsRightToBottom").length},toString:function(){function t(t,e){for(var n=t.length;e>n;n++)t+=" ";return t}for(var e="| ",n=0;n<this.get("connectionsRightToTop").length;n++)n>0&&(e+=", "),e+=t(this.get("connectionsRightToTop").at(n).cid,4);e+=" | ";for(var n=0;n<this.get("connectionsRightToBottom").length;n++)n>0&&(e+=", "),e+=t(this.get("connectionsRightToBottom").at(n).cid,4);e+=" |";for(var o=19+e.length,i=t("-------------------",o)+"\n",s="",n=0;n<this.get("connectionsTopToRight").length;n++)n>0&&(s+=","),s+=this.get("connectionsTopToRight").at(n).cid;i+=t(s,o)+"\n",i+=t("-------------------",o)+"\n";for(var s="",n=0;n<this.get("connectionsTopToLeft").length;n++)n>0&&(s+=","),s+=this.get("connectionsTopToLeft").at(n).cid;return i+=t(s,o)+"\n",i+=t("-------------------",o)+"\n",i+=t(null!=this.get("systemActivityNode")?this.get("systemActivityNode").cid+" - "+this.get("systemActivityNode").get("systemActivity").get("name"):"",19)+e,i+="\n\n"}}),t.NodeCellColumn=e.Model.Definition.Array.extend({model:t.NodeCell,getHeight:function(){return this.length},getLastOccupiedCell:function(){for(var t=-1,e=this.getHeight()-1;e>=0;e--)if(this.at(e).isOccupied()){t=e;break}return t},moveCells:function(t,e,n,o){if(0!=t||0!=e){n=n||0,n=0>n?0:n,o=o||this.getHeight()-1,o=o>this.getHeight()-1?this.getHeight()-1:o;for(var i=n;o>=i;i++){var s=this.at(i).get("systemActivityNode");if(null!=s){var a=s.get("gridPosition");-1!=a.column&&-1!=a.row&&(a.column+=t,a.row+=e,s.set("gridPosition",a))}}}},addVerticalLaneToTop:function(){for(var t=0;t<this.getHeight();t++)this.at(t).get("connectionsRightToTop").add(e.Diagram.Model.emptyLane);return this.at(0).get("connectionsRightToTop").length-1},addVerticalLaneToBottom:function(){for(var t=0;t<this.getHeight();t++)this.at(t).get("connectionsRightToBottom").add(e.Diagram.Model.emptyLane);return this.at(0).get("connectionsRightToBottom").length-1},removeVerticalLaneToTop:function(t){for(var e=0;e<this.getHeight();e++)this.at(e).get("connectionsRightToTop").removeIndex(t)},removeVerticalLaneToBottom:function(t){for(var e=0;e<this.getHeight();e++)this.at(e).get("connectionsRightToBottom").removeIndex(t)},addHorizontalLaneToRight:function(t){return this.at(t).get("connectionsTopToRight").add(e.Diagram.Model.emptyLane),this.at(t).get("connectionsTopToRight").length-1},addHorizontalLaneToLeft:function(t){return this.at(t).get("connectionsTopToLeft").add(e.Diagram.Model.emptyLane),this.at(t).get("connectionsTopToLeft").length-1},toString:function(){for(var t="",e=0;e<this.length;e++)t+=this.at(e).toString();return t}}),t.NodeCellGrid=e.Model.Definition.Array.extend({model:t.NodeCellColumn,placeSystemActivityNode:function(t,e,n){for(var o=this.getWidth();e>=o;o++)this.insertColumn(o);for(var o=this.getHeight();n>=o;o++)this.insertRow(o);1==this.at(e).at(n).isOccupied()&&this.insertColumn(e),this.at(e).at(n).set("systemActivityNode",t),t.set("gridPosition",{column:e,row:n})},placeConnection:function(t){var e,n,o=t.getFirstHorizontalLineLength();if(0!=o){var i=t.get("sourceNode").get("gridPosition").row+1,s=t.get("sourceNode").get("gridPosition").column,a=s+o;n=o>0?a-1:a,this.getHeight()==i&&this.insertRow(i);for(var r=s;r!=a;o>0?r++:r--)o>0?(e=this.addHorizontalLaneToRight(i),this.at(r).at(i).get("connectionsTopToRight").replaceIndex(e,t)):(e=this.addHorizontalLaneToLeft(i),this.at(r).at(i).get("connectionsTopToLeft").replaceIndex(e,t))}var c=t.getVerticalLineLength();if(0!=c&&null!=n){var g=c>0?this.addVerticalLaneToBottom(n):this.addVerticalLaneToTop(n),l=t.get("sourceNode").get("gridPosition").row;c>0&&(l+=1);for(var d=0;d!=c;c>0?d++:d--)this.at(n).at(l+d).get(c>0?"connectionsRightToBottom":"connectionsRightToTop").replaceIndex(g,t)}var h=t.getSecondHorizontalLineLength();if(0!=h){var i=t.get("targetNode").get("gridPosition").row,u=t.get("targetNode").get("gridPosition").column;if(h>0){var f=0!=c?this.addHorizontalLaneToRight(i):e;this.at(u).at(i).get("connectionsTopToRight").replaceIndex(f,t)}else{var f=0!=c?this.addHorizontalLaneToLeft(i):e;this.at(u).at(i).get("connectionsTopToLeft").replaceIndex(f,t)}}},getWidth:function(){return this.length},getHeight:function(){return 0==this.getWidth()?0:this.at(0).getHeight()},insertColumn:function(n){var o=!0;n>=this.getWidth()&&(n=this.getWidth(),o=!1),0>=n&&(n=0,o=!1);for(var i=this.getWidth(),s=this.getHeight(),a=new t.NodeCellColumn,r=0;s>r;r++){var c=new t.NodeCell;if(a.add(c),i>0){for(var g=this.at(0).at(r),l=g.get("connectionsTopToRight").length,d=0;l>d;d++)c.get("connectionsTopToRight").add(e.Diagram.Model.emptyLane);for(var h=g.get("connectionsTopToLeft").length,d=0;h>d;d++)c.get("connectionsTopToLeft").add(e.Diagram.Model.emptyLane)}}if(this.moveCells(1,0,n),this.addAtIndex(n,a),o){for(var u=this.at(n-1),f=this.at(n+1),r=0;r<this.getHeight();r++){for(var C=u.at(r),v=f.at(r),T=a.at(r),L=C.get("connectionsTopToRight"),S=v.get("connectionsTopToRight"),R=T.get("connectionsTopToRight"),l=L.length,d=0;l>d;d++)L.at(d).cid==S.at(d).cid&&R.replaceIndex(d,L.at(d));for(var L=C.get("connectionsTopToLeft"),S=v.get("connectionsTopToLeft"),R=T.get("connectionsTopToLeft"),h=L.length,d=0;h>d;d++)L.at(d).cid==S.at(d).cid&&R.replaceIndex(d,L.at(d))}for(var r=0;r<this.getHeight();r++){for(var C=u.at(r),v=f.at(r),T=a.at(r),L=C.get("connectionsRightToTop"),y=L.length,d=0;y>d;d++)if(!(L.at(d).get("targetNode").get("gridPosition").column<n)){var N=a.addVerticalLaneToTop(),w=null;for(m=0;m<u.getHeight();m++){var M=u.at(m).get("connectionsRightToTop").at(d);if(M.cid!=e.Diagram.Model.emptyLane.cid)newColum.at(m).get("connectionsRightToTop").replaceIndex(N,M),w=M;else{if(null!=w){var H=u.at(m).get("connectionsTopToRight");for(p=0;p<H.length;p++)if(H.at(p).cid==w.cid){a.at(m).get("connectionsTopToRight").replaceIndex(p,w);break}}w=null}}u.removeVerticalLaneToTop(d)}for(var L=C.get("connectionsRightToBottom"),A=L.length,d=0;A>d;d++)if(!(L.at(d).get("targetNode").get("gridPosition").column<n)){var N=a.addVerticalLaneToBottom(),w=null;for(m=0;m<u.getHeight();m++){var M=u.at(m).get("connectionsRightToBottom").at(d);if(M.cid!=e.Diagram.Model.emptyLane.cid){if(newColum.at(m).get("connectionsRightToBottom").replaceIndex(N,M),null==w){var H=u.at(m).get("connectionsTopToRight");for(p=0;p<H.length;p++)if(H.at(p).cid==M.cid){a.at(m).get("connectionsTopToRight").replaceIndex(p,M);break}}w=M}else w=null}u.removeVerticalLaneToBottom(d)}}}},insertRow:function(n){var o=!0;n>=this.getHeight()&&(n=this.getHeight(),o=!1),0>n&&(n=0,o=!1);for(var i=this.getHeight(),s=this.getWidth(),a=0;s>a;a++){var r=this.at(a),c=new t.NodeCell;if(i>0){for(var g=r.at(0).get("connectionsRightToTop").length,l=0;g>l;l++)c.get("connectionsRightToTop").add(e.Diagram.Model.emptyLane);for(var d=r.at(0).get("connectionsRightToBottom").length,l=0;d>l;l++)c.get("connectionsRightToBottom").add(e.Diagram.Model.emptyLane)}r.addAtIndex(n,c)}this.moveCells(0,1,0,s-1,n+1)},moveCells:function(t,e,n,o,i,s){n=n||0,n=0>n?0:n,o=o||this.getWidth()-1,o=o>this.getWidth()-1?this.getWidth()-1:o;for(var a=n;o>=a;a++)this.at(a).moveCells(t,e,i,s)},addVerticalLaneToTop:function(t){return this.at(t).addVerticalLaneToTop()},addVerticalLaneToBottom:function(t){return this.at(t).addVerticalLaneToBottom()},addHorizontalLaneToRight:function(t){for(var e,n=0;n<this.getWidth();n++){var o=this.at(n).addHorizontalLaneToRight(t);if(0==n)e=o;else if(o!=e)throw"Internal error."}return e},addHorizontalLaneToLeft:function(t){for(var e,n=0;n<this.getWidth();n++){var o=this.at(n).addHorizontalLaneToLeft(t);if(0==n)e=o;else if(o!=e)throw"Internal error."}return e},getCellAbove:function(t){return this.getCell({column:t.column,row:t.row-1})},getCellBelow:function(t){return this.getCell({column:t.column,row:t.row+1})},getCellToLeft:function(t){return this.getCell({column:t.column-1,row:t.row})},getCellToRight:function(t){return this.getCell({column:t.column+1,row:t.row})},getCell:function(t){return t.column<0||t.row<0?null:t.column>=this.getWidth()?null:t.row>=this.getHeight()?null:this.at(t.column).at(t.row)},toString:function(){for(var t=[],e=0;e<this.length;e++)t[e]=this.at(e).toString().split("\n");for(var n="",e=0;e<t[0].length;e++){n+="\n";for(var o=0;o<t.length;o++)n+=t[o][e]}return n}})});var diagramModel=Testrails.module("Diagram.Model",function(t){t.findNodeForSystemActivity=function(e){return t.systemActivityNodes.find(function(t){return t.get("systemActivity").cid==e.cid})}});diagramModel.on("start",function(){diagramModel.systemActivityNodes=new Testrails.Diagram.Model.Definition.SystemActivityNodeList,diagramModel.nodeCellGrid=new Testrails.Diagram.Model.Definition.NodeCellGrid,diagramModel.emptyLane=new Testrails.Diagram.Model.Definition.Connection}),Testrails.module("Diagram.Layout",function(t,e){t.placeIntoGrid=function(t){if(-1==t.get("position").left&&-1==t.get("position").top)if(0==t.get("incomingConnections").length)e.Diagram.Model.nodeCellGrid.placeSystemActivityNode(t,0,0);else{var n=t.get("incomingConnections").last().get("sourceNode").get("gridPosition").column,o=e.Diagram.Model.nodeCellGrid.at(n).getLastOccupiedCell()+1;e.Diagram.Model.nodeCellGrid.placeSystemActivityNode(t,n,o),e.Diagram.Model.nodeCellGrid.placeConnection(t.get("incomingConnections").last())}else t.get("incomingConnections").length>0&&null==t.get("incomingConnections").last().get("$el")&&e.Diagram.Model.nodeCellGrid.placeConnection(t.get("incomingConnections").last())}}),Testrails.module("Diagram.View",function(t,e,n,o,i,s){function a(t){var n=t.get("$el");if(null==n&&(n=i(s.template(i("#trs-diagram-tmpl-node").html(),{systemActivityNode:t})),t.set("$el",n),i(e.diagram.el).append(n)),0!=t.get("incomingConnections").length){var o=t.get("incomingConnections").last();null==o.get("$el")&&r(o)}}function r(n){function o(t,e){return e.left<t.left?t.left=e.left:e.left>t.right&&(t.right=e.left),e.top<t.top?t.top=e.top:e.top>t.bottom&&(t.bottom=e.top),t}var s=i('<svg id="conn'+n.cid+'" class="trs-diagram-connection"></svg>').appendTo(".trs-base-diagram");n.set("$el",s);var a=Snap("#conn"+n.cid),r=n.get("sourceNode"),c=r.get("position").left+t.Constants.anchorOutgoingConnectionLeft,g=r.get("position").top+t.Constants.anchorOutgoingConnectionTop,l=n.getFirstHorizonalLaneOffset(),d=t.Constants.nodeContainerHeight-t.Constants.nodeOffsetTop-t.Constants.nodeHeight+(l.fromTop>0?l.fromTop*t.Constants.horizontalLaneHeight:0),h={left:c,right:c,top:g,bottom:g+d},u=n.getFirstHorizontalLineLength(),f=u>0?t.Constants.connectionCornerRadius:0>u?-1*t.Constants.connectionCornerRadius:0,m=0==u?e.Diagram.Model.nodeCellGrid.getCellBelow(r.get("gridPosition")).getHorizontalLaneCount()*t.Constants.horizontalLaneHeight:t.Constants.connectionCornerRadius;0!=u&&(d-=m/2),h=o(h,{left:c+f,top:g+d+m});var C=u*t.Constants.nodeContainerWidth;if(0>C){C+=t.Constants.nodeContainerWidth-t.Constants.nodeOffsetLeft-t.Constants.anchorOutgoingConnectionLeft+t.Constants.connectionCornerRadius;for(var v=r.get("gridPosition").row,p=r.get("gridPosition").column-1,T=-2;T>=u;p--,T--){var L=e.Diagram.Model.nodeCellGrid.at(p).at(v).getVerticalLaneCount();C-=L*t.Constants.verticalLaneWidth}}else if(C>0){C-=t.Constants.nodeOffsetLeft+t.Constants.anchorOutgoingConnectionLeft+t.Constants.connectionCornerRadius;for(var v=r.get("gridPosition").row,p=r.get("gridPosition").column,T=1;u>T;p++,T++){var L=e.Diagram.Model.nodeCellGrid.at(p).at(v).getVerticalLaneCount();C+=L*t.Constants.verticalLaneWidth}}h=o(h,{left:c+f+C,top:g+d+m});var S=n.getVerticalLineLength(),R=n.getVerticalLaneOffset(),y=0,N=0;0!=S?(N=S>0?t.Constants.connectionCornerRadius:-1*t.Constants.connectionCornerRadius,0>C?(C-=R.fromRight*t.Constants.verticalLaneWidth-t.Constants.verticalLaneWidth/2,y=-1*t.Constants.connectionCornerRadius):C>0&&(C+=R.fromLeft*t.Constants.verticalLaneWidth-t.Constants.verticalLaneWidth/2,y=t.Constants.connectionCornerRadius)):0==S&&0!=C&&(y=e.Diagram.Model.nodeCellGrid.at(n.getVerticalLaneColumn()).at(0).getVerticalLaneCount()*t.Constants.verticalLaneWidth,0>C&&(y*=-1)),h=o(h,{left:c+f+C+y,top:g+d+m+N});var w=S*t.Constants.nodeContainerHeight;if(0>S){w-=l.fromTop*t.Constants.horizontalLaneHeight+(t.Constants.horizontalLaneHeight/2-t.Constants.connectionCornerRadius);for(var p=n.getVerticalLaneColumn(),v=r.get("gridPosition").row,T=-1;T>S;v--,T--){var M=e.Diagram.Model.nodeCellGrid.at(p).at(v).getHorizontalLaneCount();w-=M*t.Constants.horizontalLaneHeight}}else if(S>0){w+=l.fromBottom*t.Constants.horizontalLaneHeight+(t.Constants.horizontalLaneHeight/2-t.Constants.connectionCornerRadius);for(var p=n.getVerticalLaneColumn(),v=r.get("gridPosition").row+2,T=2;S>=T;v++,T++){var M=e.Diagram.Model.nodeCellGrid.at(p).at(v).getHorizontalLaneCount();w+=M*t.Constants.horizontalLaneHeight}}h=o(h,{left:c+f+C+y,top:g+d+m+N+w});var H=n.getSecondHorizontalLaneOffset(),A=n.getSecondHorizontalLineLength(),D=0!=S&&A>0?t.Constants.connectionCornerRadius:0!=S&&0>A?-1*t.Constants.connectionCornerRadius:0,z=S>0?t.Constants.connectionCornerRadius:0>S?-1*t.Constants.connectionCornerRadius:0;0>S?w-=H.fromBottom*t.Constants.horizontalLaneHeight+t.Constants.horizontalLaneHeight/2-t.Constants.connectionCornerRadius:S>0&&(w+=H.fromTop*t.Constants.horizontalLaneHeight+t.Constants.horizontalLaneHeight/2-t.Constants.connectionCornerRadius),h=o(h,{left:c+f+C+y+D,top:g+d+m+N+w+z});var x=0;-1==A?(x=-1*(t.Constants.nodeContainerWidth-t.Constants.nodeWidth-t.Constants.nodeOffsetLeft+Math.round(t.Constants.nodeWidth/4)-t.Constants.connectionCornerRadius),0!=S&&(x-=R.fromLeft*t.Constants.verticalLaneWidth+t.Constants.verticalLaneWidth/2-t.Constants.connectionCornerRadius)):1==A&&(x=t.Constants.nodeOffsetLeft+Math.round(t.Constants.nodeWidth/4)-t.Constants.connectionCornerRadius,0!=S&&(x+=R.fromRight*t.Constants.verticalLaneWidth+t.Constants.verticalLaneWidth/2-t.Constants.connectionCornerRadius)),h=o(h,{left:c+f+C+y+D+x,top:g+d+m+N+w+z});var W=0,O=0;-1==A?(W=-1*t.Constants.connectionCornerRadius,O=t.Constants.connectionCornerRadius):1==A&&(W=t.Constants.connectionCornerRadius,O=t.Constants.connectionCornerRadius),h=o(h,{left:c+f+C+y+D+x+W,top:g+d+m+N+w+z+O});var V=t.Constants.nodeOffsetTop;0!=A&&(V+=H.fromBottom*t.Constants.horizontalLaneHeight+t.Constants.horizontalLaneHeight/2-t.Constants.connectionCornerRadius),h=o(h,{left:c+f+C+y+D+x+W,top:g+d+m+N+w+z+O+V}),h.width=h.right-h.left,h.height=h.bottom-h.top;var P="M "+(c-h.left+t.Constants.connectionLineWidth/2)+" "+(g-h.top+t.Constants.connectionLineWidth/2)+" "+"v "+d+" "+(0==f&&0==m?"c 0 0 0 0 0 0 ":"c 0 "+Math.round(.55*m)+" "+Math.round(.45*f)+" "+m+" "+f+" "+m+" ")+"h "+C+" "+(0==y&&0==N?"c 0 0 0 0 0 0 ":"c "+Math.round(.55*y)+" 0 "+y+" "+Math.round(.45*N)+" "+y+" "+N+" ")+"v "+w+" "+(0==D&&0==z?"c 0 0 0 0 0 0 ":"c 0 "+Math.round(.55*z)+" "+Math.round(.45*D)+" "+z+" "+D+" "+z+" ")+"h "+x+" "+(0==W&&0==O?"c 0 0 0 0 0 0 ":"c "+Math.round(.55*W)+" 0 "+W+" "+Math.round(.45*O)+" "+W+" "+O+" ")+"v "+V;h.left-=t.Constants.connectionLineWidth/2,h.top-=t.Constants.connectionLineWidth/2,h.width+=t.Constants.connectionLineWidth,h.height+=t.Constants.connectionLineWidth,s.css({left:String(h.left)+"px",top:String(h.top)+"px",width:String(h.width)+"px",height:String(h.height)+"px"});var I=a.path(P);I.attr({stroke:"#363636",strokeWidth:6,"fill-opacity":0})}t.Constants={nodeContainerHeight:154,nodeContainerWidth:264,nodeHeight:84,nodeWidth:200,horizontalLaneHeight:40,verticalLaneWidth:40,connectionCornerRadius:40,connectionLineWidth:6},t.Constants.nodeOffsetTop=(t.Constants.nodeContainerHeight-t.Constants.nodeHeight)/2,t.Constants.nodeOffsetLeft=(t.Constants.nodeContainerWidth-t.Constants.nodeWidth)/2,t.Constants.anchorOutgoingConnectionTop=t.Constants.nodeHeight,t.Constants.anchorOutgoingConnectionLeft=t.Constants.nodeWidth/2,t.refresh=function(){for(var n=e.Diagram.Model.nodeCellGrid.getWidth(),o=e.Diagram.Model.nodeCellGrid.getHeight(),i=[],s=[],r=[],c=[],g=0;n>g;g++)for(var l=e.Diagram.Model.nodeCellGrid.at(g),d=0;o>d;d++){var h=l.at(d);0==d&&(i[g]=h.getVerticalLaneCount()*t.Constants.verticalLaneWidth+t.Constants.nodeContainerWidth,s[g]=0==g?0:s[g-1]+i[g-1]),0==g&&(r[d]=h.getHorizontalLaneCount()*t.Constants.horizontalLaneHeight+t.Constants.nodeContainerHeight,c[d]=0==d?0:c[d-1]+r[d-1]);var u=h.get("systemActivityNode");null!=u&&(u.set("position",{left:s[g]+t.Constants.nodeOffsetLeft,top:c[d]+h.getHorizontalLaneCount()*t.Constants.horizontalLaneHeight+t.Constants.nodeOffsetTop}),a(u))}},t.addInitializer(function(){e.Diagram.Model.systemActivityNodes.on("change:position",function(t){if($el=t.get("$el"),null!=$el){t.get("$el").animate({left:t.get("position").left+"px",top:t.get("position").top+"px"});for(var e=0;e<t.get("outgoingConnections").length;e++){var n=t.get("outgoingConnections").at(e);null!=n.get("$el")&&n.get("$el").remove(),r(n)}for(var e=0;e<t.get("incomingConnections").length;e++){var n=t.get("incomingConnections").at(e);null!=n.get("$el")&&n.get("$el").remove(),r(n)}}})})}),Testrails.module("Diagram.Controller",function(t,e){function n(t,n){var o,i=n.indexOf(t);i>0&&(o=n.at(i-1));var s=e.Diagram.Model.findNodeForSystemActivity(t.get("forSystemActivity"));if(null==s&&(s=new e.Diagram.Model.Definition.SystemActivityNode,s.set("systemActivity",t.get("forSystemActivity")),e.Diagram.Model.systemActivityNodes.add(s)),s.get("sensorReadings").add(t),o){var a=e.Diagram.Model.findNodeForSystemActivity(o.get("forSystemActivity"));a&&0==a.hasOutgoingConnectionTo(s)&&new e.Diagram.Model.Definition.Connection({sourceNode:a,targetNode:s})}return s}t.watch=function(t){this.listenTo(t.get("sensorReadings"),"add",function(t,o){var i=n(t,o);e.Diagram.Layout.placeIntoGrid(i),e.Diagram.View.refresh()})},t.focus=function(){}}),Testrails.module("Diagram.ScopeFilter",function(t,e){t.onNewSensorReadingSequence=function(t){e.Diagram.Controller.watch(t,!0)},t.addInitializer(function(){this.listenTo(e.Model.sensorReadingSequences,"add",function(e){t.onNewSensorReadingSequence(e)})})}),Testrails.start();